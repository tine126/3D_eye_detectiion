# TCL人眼定位算法定制项目

## 项目概述

本项目是一个基于ROS2的人眼定位算法系统，主要用于在地平线RDK系列开发板上实现人体检测和人脸关键点定位功能。项目整合了三个核心代码包，通过深度相机采集图像数据，利用BPU处理器进行AI模型推理，实现实时的人眼定位功能。

## 项目架构

```
code/
├── mono2d_body_detection/      # 单目2D人体检测包
├── face_landmarks_detection/   # 人脸106关键点检测包
└── OrbbecSDK_ROS2/            # Orbbec深度相机ROS2驱动
```

## 代码包详细说明

---

### 1. mono2d_body_detection（单目2D人体检测）

**版本**: 2.5.0
**许可证**: Apache License 2.0

#### 功能描述

使用hobot_dnn开发的单目RGB人体检测算法，在RDK系列开发板上利用BPU处理器进行模型推理。

#### 支持的检测模型

| 模型类型 | 输出内容 | 支持平台 |
|---------|---------|---------|
| fasterRcnn | 人体框、人头框、人脸框、人手框、人体关键点 | RDK X3 / RDK Ultra / RDK X5 |
| yolo-pose | 人体框、人体关键点 | RDK S100 / RDK S600 |

#### 核心类

- **Mono2dBodyDetNode**: 主检测节点，继承自DNN节点
- **NodeOutputManage**: 输出管理类
- **FasterRcnnOutput**: FasterRcnn模型输出结构

#### 主要功能方法

- `SetNodePara()`: 设置节点参数
- `PostProcess()`: 后处理推理结果
- `Predict()`: 执行模型推理
- `RosImgProcess()`: 处理ROS图像消息
- `DoMot()`: 执行多目标跟踪

#### ROS2话题

| 话题名称 | 消息类型 | 说明 |
|---------|---------|------|
| /hobot_mono2d_body_detection | ai_msgs/PerceptionTargets | 发布检测到的人体目标信息 |
| /hbmem_img | hbm_img_msgs/HbmMsg1080P | shared mem方式订阅图像 |
| /image_raw | sensor_msgs/Image | 普通方式订阅图像 |

#### 关键参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|-------|------|
| model_file_name | string | config/multitask_body_head_face_hand_kps_960x544.hbm | 模型文件路径 |
| is_sync_mode | int | 0 | 同步/异步推理模式 |
| is_shared_mem_sub | int | 1 | 是否使用shared mem通信 |
| model_type | int | 0 | 模型类型(0:fasterRcnn, 1:yolo-pose) |
| track_mode | int | 1 | 跟踪模式(0:不跟踪, 1:跟踪) |
| image_gap | int | 1 | 抽帧间隔 |

#### 依赖项

- rclcpp, dnn_node, cv_bridge, sensor_msgs
- hbm_img_msgs, ai_msgs, hobot_cv, hobot_mot

---

### 2. face_landmarks_detection（人脸关键点检测）

**版本**: 2.3.1
**许可证**: Apache-2.0

#### 功能描述

人脸106关键点检测功能包，可检测人脸上的106个关键点位置，用于精确定位眼睛、鼻子、嘴巴等面部特征。

#### 支持平台

| 平台 | 支持状态 |
|-----|---------|
| RDK X3 | 支持 |
| RDK X5 | 支持 |

#### 核心类

- **FaceLandmarksDetNode**: 人脸关键点检测主节点
- **FaceLandmarksDetOutput**: 检测输出结构
- **FeedbackImgInfo**: 反馈图像信息结构

#### 主要功能方法

- `SetNodePara()`: 设置节点参数
- `PostProcess()`: 后处理推理结果
- `Predict()`: 执行模型推理
- `Render()`: 渲染检测结果
- `AiMsgProcess()`: 处理AI消息
- `RosImgProcess()`: 处理ROS图像消息
- `NormalizeRoi()`: 归一化ROI区域
- `SaveLandmarksToTxt()`: 保存关键点到文本文件

#### 关键参数

| 参数名 | 默认值 | 说明 |
|-------|-------|------|
| feed_type | 0 | 0:实时推理, 1:离线图像推理 |
| feed_image_path | ./config/image.png | 输入图像路径 |
| model_file_name | ./config/faceLandmark106pts.hbm | 模型文件 |
| is_sync_mode | 0 | 0:异步推理, 1:同步推理 |
| is_shared_mem_sub | 1 | 是否使用shared mem通信 |
| dump_render_img | 0 | 是否保存渲染图像 |
| ai_msg_pub_topic_name | /face_landmarks_detection | 发布话题名称 |

#### 依赖项

- rclcpp, sensor_msgs, dnn_node
- hbm_img_msgs, ai_msgs

---

### 3. OrbbecSDK_ROS2（Orbbec相机驱动）

**许可证**: Apache License 2.0

#### 功能描述

OrbbecSDK ROS2 Wrapper提供Orbbec深度相机与ROS2环境的无缝集成，支持RGB图像、深度图像、红外图像等多种数据流的采集和发布。

#### 支持的ROS2版本

- ROS2 Foxy
- ROS2 Humble
- ROS2 Jazzy

#### 支持的相机型号

| 产品系列 | 型号 | 启动文件 |
|---------|------|---------|
| Gemini 330系列 | Gemini 330/335/336/335L/336L/330L/335Le/335Lg | gemini_330_series.launch.py |
| Gemini 340系列 | Gemini 345/345Lg | gemini345.launch.py |
| Gemini 2系列 | Gemini 2/2L/215/210 | gemini2.launch.py |
| Femto系列 | Femto Bolt/Mega/Mega I | femto_bolt.launch.py |
| Astra系列 | Astra 2/Mini Pro | astra2.launch.py |
| LiDAR系列 | Pulsar ME450/SL450 | lidar.launch.py |

#### 子包结构

```
OrbbecSDK_ROS2/
├── orbbec_camera/          # 相机驱动核心包
├── orbbec_camera_msgs/     # 自定义消息定义
└── orbbec_description/     # 相机URDF描述文件
```

#### 主要功能

- RGB/深度/红外图像流采集
- 点云数据生成
- 相机内外参获取
- 多相机同步支持
- 硬件同步触发

---

## 系统工作流程

```
┌─────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  Orbbec相机     │────▶│  mono2d_body_        │────▶│  face_landmarks_    │
│  (RGB图像采集)  │     │  detection           │     │  detection          │
│                 │     │  (人体/人脸检测)     │     │  (106关键点检测)    │
└─────────────────┘     └──────────────────────┘     └─────────────────────┘
                                  │                            │
                                  ▼                            ▼
                        ┌──────────────────┐         ┌──────────────────┐
                        │  人体框/人脸框   │         │  人眼位置坐标    │
                        │  人体关键点      │         │  (106点中的眼部) │
                        └──────────────────┘         └──────────────────┘
```

## 硬件要求

### 开发板支持

| 开发板 | mono2d_body_detection | face_landmarks_detection |
|-------|----------------------|-------------------------|
| RDK X3 | ✓ (fasterRcnn) | ✓ |
| RDK X5 | ✓ (fasterRcnn) | ✓ |
| RDK Ultra | ✓ (fasterRcnn) | - |
| RDK S100 | ✓ (yolo-pose) | - |
| RDK S600 | ✓ (yolo-pose) | - |

### 相机支持

- MIPI相机
- USB相机
- Orbbec深度相机（Gemini/Femto/Astra系列）

## 软件环境

### 操作系统

- Ubuntu 20.04 (ROS2 Foxy)
- Ubuntu 22.04 (ROS2 Humble)
- Ubuntu 24.04 (ROS2 Jazzy)

### 依赖框架

- TogetheROS (tros.b)
- hobot_dnn (地平线DNN推理框架)
- OrbbecSDK v2

## 快速开始

### 1. 安装依赖

```bash
# 安装tros.b humble版本
sudo apt update
sudo apt install -y tros-humble-mono2d-body-detection
```

### 2. 启动人体检测

```bash
# 配置环境
source /opt/tros/humble/setup.bash
cp -r /opt/tros/${TROS_DISTRO}/lib/mono2d_body_detection/config/ .

# 使用USB相机
export CAM_TYPE=usb
ros2 launch mono2d_body_detection mono2d_body_detection.launch.py
```

### 3. 启动人脸关键点检测（联合检测）

```bash
source /opt/tros/humble/setup.bash
export CAM_TYPE=usb
ros2 launch face_landmarks_detection body_det_face_landmarks_det.launch.py
```

### 4. 查看检测结果

在同一网络下的浏览器中访问 `http://<RDK_IP>:8000` 查看实时检测效果。

## 输出数据格式

### 人体检测输出 (PerceptionTargets)

```
std_msgs/Header header      # 消息头
int16 fps                   # 处理帧率
Perf[] perfs               # 性能统计
Target[] targets           # 检测目标集合
Target[] disappeared_targets # 消失目标集合
```

### 人脸关键点输出

106个关键点坐标，包含：
- 眼睛轮廓点（左眼、右眼各若干点）
- 眉毛轮廓点
- 鼻子轮廓点
- 嘴巴轮廓点
- 脸部轮廓点

## 项目特点

1. **高性能推理**: 利用地平线BPU处理器进行硬件加速推理
2. **实时处理**: 支持实时视频流处理和离线图像处理
3. **多目标跟踪**: 内置MOT（多目标跟踪）算法
4. **灵活配置**: 支持多种相机类型和模型配置
5. **ROS2生态**: 完全兼容ROS2生态系统，便于集成

## 许可证

- mono2d_body_detection: Apache License 2.0
- face_landmarks_detection: Apache-2.0
- OrbbecSDK_ROS2: Apache License 2.0

## 维护者

- mono2d_body_detection: zhukao (kao.zhu@d-robotics.cc)
- face_landmarks_detection: zhikang.zeng (zhikang.zeng@d-robotics.cc)
- OrbbecSDK_ROS2: Orbbec Ltd.
