# TCL人眼定位算法项目部署方案

## 1. 项目概述

本项目基于ROS2实现双路IR相机的人脸检测和关键点定位功能。

### 1.1 数据流架构

```
┌─────────────────┐     ┌──────────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Gemini 335L    │     │  img_format_converter │     │ mono2d_body_det │     │ face_landmarks  │
│  双目IR相机     │     │  格式转换节点         │     │ 人脸检测节点    │     │ 关键点检测节点  │
│                 │     │                      │     │                 │     │                 │
│  左IR (Y8)      │────>│  mono8 -> nv12       │────>│  人脸框检测     │────>│  106点关键点    │
│  右IR (Y8)      │────>│  SharedMem发布       │────>│  双路并行处理   │────>│  双路并行处理   │
└─────────────────┘     └──────────────────────┘     └─────────────────┘     └─────────────────┘
```

### 1.2 Topic映射表

| 阶段 | 左IR Topic | 右IR Topic |
|------|------------|------------|
| 相机输出 | /camera/left_ir/image_raw | /camera/right_ir/image_raw |
| 格式转换输出 | /hbmem_img_left | /hbmem_img_right |
| 人脸检测输出 | /hobot_mono2d_body_detection_left | /hobot_mono2d_body_detection_right |
| 关键点输出 | /face_landmarks_detection_left | /face_landmarks_detection_right |

## 2. 硬件要求

| 组件 | 规格 |
|------|------|
| 开发板 | 地平线RDK X5 |
| 相机 | Orbbec Gemini 335L |
| 连接 | USB 3.0 |
| 内存 | >= 4GB |

## 3. 软件依赖

### 3.1 系统环境

- Ubuntu 22.04 (RDK X5)
- ROS2 Humble
- TogetheROS

### 3.2 ROS2依赖包

```bash
# 基础依赖
sudo apt install ros-humble-rclcpp ros-humble-sensor-msgs

# 地平线依赖 (TogetheROS已包含)
# - dnn_node
# - hbm_img_msgs
# - ai_msgs
# - hobot_cv
```

## 4. 编译步骤

### 4.1 创建工作空间

```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src

# 克隆项目代码
git clone <项目仓库地址> tcl_eye_tracking
```

### 4.2 编译所有节点

```bash
cd ~/ros2_ws

# 设置交叉编译环境 (如需要)
source /opt/tros/humble/setup.bash

# 编译
colcon build --packages-select \
    img_format_converter \
    mono2d_body_detection \
    face_landmarks_detection

# 刷新环境
source install/setup.bash
```

### 4.3 单独编译

```bash
# 格式转换节点
colcon build --packages-select img_format_converter

# 人脸检测节点
colcon build --packages-select mono2d_body_detection

# 关键点检测节点
colcon build --packages-select face_landmarks_detection
```

## 5. 运行步骤

### 5.1 启用零拷贝通信

```bash
# 设置环境变量 (每次启动终端都需要)
export RMW_FASTRTPS_USE_QOS_FROM_XML=1
export FASTRTPS_DEFAULT_PROFILES_FILE=/opt/tros/humble/lib/hobot_shm/config/shm_fastdds.xml
```

### 5.2 启动相机节点

```bash
# 终端1: 启动Gemini 335L相机
source /opt/tros/humble/setup.bash
source ~/ros2_ws/install/setup.bash

ros2 launch orbbec_camera gemini_330_series.launch.py \
    enable_left_ir:=true \
    enable_right_ir:=true \
    left_ir_format:=Y8 \
    right_ir_format:=Y8 \
    left_ir_width:=1280 \
    left_ir_height:=800 \
    left_ir_fps:=30 \
    right_ir_width:=1280 \
    right_ir_height:=800 \
    right_ir_fps:=30
```

### 5.3 启动格式转换节点

```bash
# 终端2: 启动img_format_converter
source /opt/tros/humble/setup.bash
source ~/ros2_ws/install/setup.bash

ros2 launch img_format_converter img_format_converter.launch.py \
    log_level:=info
```

### 5.4 启动人脸检测节点

```bash
# 终端3: 启动mono2d_body_detection
source /opt/tros/humble/setup.bash
source ~/ros2_ws/install/setup.bash

ros2 launch mono2d_body_detection mono2d_body_detection_without_camera.launch.py \
    score_threshold:=0.5 \
    log_level:=warn
```

### 5.5 启动关键点检测节点

```bash
# 终端4: 启动face_landmarks_detection
source /opt/tros/humble/setup.bash
source ~/ros2_ws/install/setup.bash

ros2 launch face_landmarks_detection face_landmarks_det_node.launch.py \
    score_threshold:=0.5 \
    log_level:=warn
```

### 5.6 一键启动脚本 (可选)

创建 `start_all.sh`:

```bash
#!/bin/bash
# 设置零拷贝环境
export RMW_FASTRTPS_USE_QOS_FROM_XML=1
export FASTRTPS_DEFAULT_PROFILES_FILE=/opt/tros/humble/lib/hobot_shm/config/shm_fastdds.xml

source /opt/tros/humble/setup.bash
source ~/ros2_ws/install/setup.bash

# 后台启动各节点
ros2 launch orbbec_camera gemini_330_series.launch.py \
    enable_left_ir:=true enable_right_ir:=true \
    left_ir_format:=Y8 right_ir_format:=Y8 &

sleep 2

ros2 launch img_format_converter img_format_converter.launch.py &
ros2 launch mono2d_body_detection mono2d_body_detection_without_camera.launch.py &
ros2 launch face_landmarks_detection face_landmarks_det_node.launch.py &

wait
```

## 6. 参数配置说明

### 6.1 img_format_converter 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `left_sub_topic` | `/camera/left_ir/image_raw` | 左IR输入topic |
| `left_pub_topic` | `/hbmem_img_left` | 左IR输出topic |
| `right_sub_topic` | `/camera/right_ir/image_raw` | 右IR输入topic |
| `right_pub_topic` | `/hbmem_img_right` | 右IR输出topic |
| `image_width` | `1280` | 图像宽度 |
| `image_height` | `800` | 图像高度 |

### 6.2 mono2d_body_detection 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `model_file_name` | `config/multitask_body_head_face_hand_kps_960x544.hbm` | 模型文件路径 |
| `is_sync_mode` | `0` | 推理模式 (0=异步, 1=同步) |
| `score_threshold` | `0.5` | 人脸检测置信度阈值 |
| `left_img_topic` | `/hbmem_img_left` | 左IR图像输入 |
| `left_pub_topic` | `/hobot_mono2d_body_detection_left` | 左IR检测输出 |
| `right_img_topic` | `/hbmem_img_right` | 右IR图像输入 |
| `right_pub_topic` | `/hobot_mono2d_body_detection_right` | 右IR检测输出 |

### 6.3 face_landmarks_detection 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `model_file_name` | `config/faceLandmark106pts.hbm` | 模型文件路径 |
| `is_sync_mode` | `0` | 推理模式 (0=异步, 1=同步) |
| `score_threshold` | `0.5` | 人脸检测置信度阈值 |
| `expand_scale` | `1.25` | ROI扩展比例 |
| `roi_size_min` | `16` | 最小ROI尺寸 |
| `roi_size_max` | `255` | 最大ROI尺寸 |
| `cache_len_limit` | `8` | 图像缓存上限 |
| `ai_msg_timeout_ms` | `200` | AI消息匹配超时(ms) |
| `left_img_topic` | `/hbmem_img_left` | 左IR图像输入 |
| `left_ai_sub_topic` | `/hobot_mono2d_body_detection_left` | 左IR AI订阅 |
| `left_ai_pub_topic` | `/face_landmarks_detection_left` | 左IR关键点输出 |
| `right_img_topic` | `/hbmem_img_right` | 右IR图像输入 |
| `right_ai_sub_topic` | `/hobot_mono2d_body_detection_right` | 右IR AI订阅 |
| `right_ai_pub_topic` | `/face_landmarks_detection_right` | 右IR关键点输出 |

## 7. 验证方法

### 7.1 检查Topic列表

```bash
ros2 topic list
```

预期输出应包含:
```
/camera/left_ir/image_raw
/camera/right_ir/image_raw
/hbmem_img_left
/hbmem_img_right
/hobot_mono2d_body_detection_left
/hobot_mono2d_body_detection_right
/face_landmarks_detection_left
/face_landmarks_detection_right
```

### 7.2 检查Topic频率

```bash
# 检查相机输出频率
ros2 topic hz /camera/left_ir/image_raw

# 检查格式转换输出频率
ros2 topic hz /hbmem_img_left

# 检查人脸检测输出频率
ros2 topic hz /hobot_mono2d_body_detection_left

# 检查关键点输出频率
ros2 topic hz /face_landmarks_detection_left
```

### 7.3 查看检测结果

```bash
# 查看人脸检测结果 (不显示数组内容)
ros2 topic echo /hobot_mono2d_body_detection_left --no-arr

# 查看关键点检测结果
ros2 topic echo /face_landmarks_detection_left --no-arr
```

### 7.4 性能监控

各节点会定期输出性能统计日志:

**img_format_converter**:
```
[统计] 左IR: 30帧, 右IR: 30帧, 转换: 0.5/0.3/0.8ms, 延迟: 2.1/1.5/3.2ms
```

**mono2d_body_detection**:
```
[Perf] in_fps: 30.0, out_fps: 30.0, infer: 15ms
```

**face_landmarks_detection**:
```
[Perf] in_fps: 30.0, out_fps: 30.0, infer: 8ms, match_rate: 95.0%
```

## 8. 故障排查

### 8.1 相机无法启动

**现象**: 相机节点启动失败或无图像输出

**排查步骤**:
```bash
# 检查USB连接
lsusb | grep Orbbec

# 检查设备权限
ls -la /dev/video*

# 设置udev规则 (如需要)
sudo cp /path/to/orbbec.rules /etc/udev/rules.d/
sudo udevadm control --reload-rules
```

### 8.2 格式转换节点无输出

**现象**: `/hbmem_img_left` 无数据

**排查步骤**:
1. 确认相机topic有数据: `ros2 topic hz /camera/left_ir/image_raw`
2. 检查图像格式是否为mono8: `ros2 topic echo /camera/left_ir/image_raw --field encoding`
3. 确认topic名称匹配

### 8.3 人脸检测无结果

**现象**: 检测输出中targets为空

**可能原因**:
- 图像中无人脸
- 置信度阈值过高，尝试降低 `score_threshold`
- 光照条件不佳

### 8.4 关键点匹配率低

**现象**: `match_rate` 低于80%

**可能原因**:
- 图像与AI消息时间戳不匹配
- 增大 `ai_msg_timeout_ms` 参数
- 增大 `cache_len_limit` 参数

### 8.5 零拷贝未生效

**现象**: 内存占用高，延迟大

**排查步骤**:
```bash
# 确认环境变量已设置
echo $RMW_FASTRTPS_USE_QOS_FROM_XML
echo $FASTRTPS_DEFAULT_PROFILES_FILE

# 确认配置文件存在
ls -la /opt/tros/humble/lib/hobot_shm/config/shm_fastdds.xml
```

### 8.6 模型加载失败

**现象**: 节点启动时报模型加载错误

**排查步骤**:
1. 确认模型文件存在于config目录
2. 检查文件权限
3. 确认模型文件未损坏

## 9. 注意事项

1. **启动顺序**: 建议按 相机 → 格式转换 → 人脸检测 → 关键点检测 顺序启动
2. **资源占用**: 双路处理会占用更多BPU资源，注意监控系统负载
3. **日志级别**: 生产环境建议使用 `warn` 级别减少日志输出
4. **零拷贝**: 必须在每个终端设置环境变量才能启用SharedMem零拷贝
