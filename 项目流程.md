# TCL人眼定位算法定制项目 - 完整流程

## 项目概述

基于双目IR相机的人眼三维定位系统，通过人体检测、人脸关键点检测、双目视差计算，实现人眼的三维坐标定位。

## 硬件平台

| 组件 | 型号 | 参数 |
|------|------|------|
| 相机 | 奥比中光 Gemini 335L | 双目IR，1280×800，mono8，增益100，曝光4ms |
| 开发板 | 地平线 RDK X5 | 征程5芯片，BPU加速 |

## 系统架构总览

```
Gemini 335L 双目IR相机
├── 左路IR (1280×800, mono8)
└── 右路IR (1280×800, mono8)
        ↓
格式转换 (mono8 → nv12)
        ↓
人体检测 (按需触发) → face roi
        ↓
人脸关键点检测 (106点)
        ↓
人眼2D坐标提取 (轮廓点平均)
        ↓
双目视差三维坐标计算
        ↓
输出: 左眼(X,Y,Z) 右眼(X,Y,Z)
```

---

## 1. IR流采集

**来源**: OrbbecSDK_ROS2

| 参数 | 值 |
|------|-----|
| 分辨率 | 1280×800 |
| 格式 | mono8 (灰度图) |
| 增益 | 100 |
| 曝光 | 4ms |

**关键代码路径**:
- 取流: `ob_camera_node.cpp:3157`
- 过滤: `processLeftIrFrameFilter()`
- 发布: `ob_camera_node.cpp:3738`

---

## 2. 数据处理(待开发)

mono8 → nv12 转换节点
1280×800 → 960×544图像缩放
---

## 3. 人体检测

**来源**: mono2d_body_detection

| 参数 | 值 |
|------|-----|
| 模型 | FasterRCNN (model_type=0) |
| 输入 | 960×544 (nv12) |
| 输出 | face roi |

**触发策略**:
- 初始帧：必须执行
- 第N帧：周期性执行（N待定）
- 无ROI：人脸检测丢失时立即触发

**双路处理**: 左右路独立维护触发状态

---

## 4. 人脸关键点检测

**来源**: face_landmarks_detection

| 参数 | 值 |
|------|-----|
| 模型 | faceLandmark106pts.hbm |
| 输出 | 106个关键点 |
| ROI扩展 | 1.25倍 |

**ROI更新策略**:
1. 优先使用上一帧人脸检测框（扩大后）
2. 其次使用人体检测的人脸区域
3. 若都无，触发人体检测重新获取

**双路处理**: 左右路独立维护ROI状态

---

## 5. 人眼2D坐标提取 (待开发)

**眼睛关键点索引**:
| 部位 | 点索引 |
|------|--------|
| 左眼轮廓 | 33-41 (9点) |
| 右眼轮廓 | 42-50 (9点) |

**计算方法**: 轮廓点平均
```cpp
left_eye = average(points[33:41])
right_eye = average(points[42:50])
```

---

## 6. 人眼3D坐标计算 (待开发)

**输入**: 左路2D坐标 + 右路2D坐标 + 相机标定参数

**三角测量公式**:
```
视差: d = x_left - x_right
深度: Z = f * B / d
坐标: X = (x_left - cx) * Z / f
      Y = (y_left - cy) * Z / f
```

**输出**: 左眼(X,Y,Z) 右眼(X,Y,Z) 单位mm

---

## 话题流转

```
/image_raw_left ──→ 人体检测 ──→ /body_detection_left
/image_raw_right ─→ 人体检测 ──→ /body_detection_right
        ↓                              ↓
/image_raw_left ──→ 人脸关键点 ─→ /face_landmarks_left
/image_raw_right ─→ 人脸关键点 ─→ /face_landmarks_right
                                       ↓
                    人眼2D提取 ──→ /eye_positions_left
                                  /eye_positions_right
                                       ↓
                    3D计算 ────→ /eye_positions_3d
```

---

## 开发状态

| 模块 | 状态 |
|------|------|
| IR流采集 | ✅ 已有代码 |
| 格式转换 (mono8→nv12) | ⏳ 待开发 |
| 人体检测 | ✅ 已有代码，需改触发策略 |
| 人脸关键点检测 | ✅ 已有代码，需改ROI策略 |
| 人眼2D坐标提取 | ⏳ 待开发 |
| 人眼3D坐标计算 | ⏳ 待开发 |
